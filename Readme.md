# SecureEscrow
SecureEscrow proxies requests made to your application on a secure domain, stores the response, redirects the user to resources on an insecure domain, and serves the proxied response. It uses your preferred key-value store to hold responses between requests.

## The Goals
This tool was created for two purposes:

- Secure authentication from an insecure page without a full-page refresh
- Secure authentication from a 3rd party-domain

## The Solution
Instead of submitting secure actions via XHR, we submit them using a hidden iframe
by dynamically creating a target iframe and modifying a form's target to submit to
that iframe.

## Installation
Add the following line to your <tt>Gemfile</tt>.
````ruby
gem 'secure_escrow'
````
Update your application's bundle.
````
$ bundle install
````

## Usage
SecureEscrow has 5 integration points with a Rails application

- Middleware surrounding your application
- Domain information in application configuration
- Routes declared as escrowed
- JavaScript delivered via the asset pipeline
- Forms generated by views

### Install as Middleware
Add the SecureEscrow::Middleware around your Rails application. It must be configured with access to a backing key-value store.
In this example, the <tt>Awesome::Application.config.redis</tt> value is available after the <tt>environment</tt> file has been run.

Example <tt>config.ru</tt>:

````ruby
# This file is used by Rack-based servers to start the application.
require ::File.expand_path('../config/environment',  __FILE__)
use SecureEscrow::Middleware, Awesome::Application.config.redis
run Awesome::Application
````

### Configure Domain Information
Ordinarily Rails simply uses the client-supplied request hostname to generate URLs.  SecureEscrow needs to redirect to a
domain which may not be the same as the incoming request. Configuration is supplied on the Rails application instance, and
may differ for various environments. For example, in <tt>development.rb</tt> you might have the following config.

````ruby
# = SecureEscrow config =
config.secure_domain_name       = 'www.secure-awesome.devlocal'
config.secure_domain_protocol   = 'http'
config.secure_domain_port       = 3000
config.insecure_domain_name     = 'www.insecure-awesome.devlocal'
config.insecure_domain_protocol = 'http'
config.insecure_domain_port     = 3000 
`````

### Declare Escrowed Routes
In your Rails application's <tt>routes.rb</tt> file you can declare escrowed routes. Escrow only applies to POST actions.
In the following example, I show replacing a <tt>post</tt> route with an <tt>escrow</tt> route.

#### Before
```` ruby
get    'signin' => 'sessions#new',      as: :new_user_session
post   'signin' => 'sessions#create',   as: :user_session
get    'signout'=> 'sessions#destroy',  as: :destroy_user_session
````

#### After
````ruby
get    'signin' => 'sessions#new',      as: :new_user_session
escrow 'signin' => 'sessions#create',   as: :user_session
get    'signout'=> 'sessions#destroy',  as: :destroy_user_session
````

### Deliver JavaScript assets
SecureEscrow integrates in the Rails asset pipeline. Just add the following to your <tt>application.js</tt>.

````ruby
// SecureEscrow
// ======================
//= require secure_escrow
````

 
### Generate forms that submit to the escrow
View helpers are provided to generate forms that submit to the escrow.
 
Replace <tt>form_for</tt> with <tt>escrow_form_for</tt> and <tt>form_tag</tt> with <tt>escrow_form_tag</tt>.

## License

MIT

